<div class="p-4">
  <div class="flex align-items-center justify-content-between mb-4">
    <div >
      <h2 *ngIf="!selectedEvent" class="m-0">{{ title }}</h2>
      <p *ngIf="!selectedEvent" class="text-sm text-600 m-0">Galeria de eventos — clique em um cartão para abrir a checklist</p>
    </div>

    <div>
      <button *ngIf="!selectedEvent" pButton type="button" label="Criar evento" icon="pi pi-plus" (click)="createSidebarVisible = true"></button>
      <button *ngIf="selectedEvent" pButton type="button" label="Editar evento" icon="pi pi-pencil" (click)="openEditEvent(selectedEvent)"></button>
    </div>
  </div>

  <!-- Gallery (PrimeFlex grid) -->
  <div *ngIf="!selectedEvent" class="grid">
    <div *ngFor="let ev of events" class="col-12 sm:col-6 md:col-4">
      <p-card (click)="selectEvent(ev)" class="shadow-2">
        <ng-template pTemplate="header">
          <div class="relative">
            <img [src]="ev.image || 'assets/img/box.png'" [alt]="ev.title" class="w-full border-round-top h-12rem object-cover" />
            <div *ngIf="getEventIsAllChecked(ev)" class="absolute top-0 right-0 bg-white border-round p-1" title="Concluído">
              <img src="assets/img/achievement.svg" alt="achievement" class="w-2rem h-2rem" />
            </div>
          </div>
        </ng-template>
        <div class="mt-3">
          <div class="flex flex-column gap-2">
            <div class="text-lg font-medium">{{ ev.title }}</div>
            <div class="flex align-items-center gap-2">
              <p-progressBar [value]="getEventProgress(ev)" style="flex:1"></p-progressBar>
              <small class="text-sm text-600">{{ getEventCheckedCount(ev) }} / {{ ev.tasks.length }}</small>
            </div>
          </div>
        </div>
      </p-card>
    </div>
  </div>
  <!-- Detail / checklist view -->
  <div *ngIf="selectedEvent as sel">
    <p-card>
      <ng-template pTemplate="header">
        <div class="flex align-items-center gap-3">
          <button pButton type="button" icon="pi pi-arrow-left" class="p-button-text" (click)="backToGallery()"></button>
          <div>
            <div class="text-2xl font-semibold">{{ sel.title }}</div>
          </div>
        </div>
      </ng-template>

      <div class="flex justify-center">
        <img [src]="sel.image" [alt]="sel.title" class="border-round" style="max-width:600px; width:100%; height:auto; max-height:300px; object-fit:cover; display:block; margin:0 auto;" />
      </div>

      <div class="p-3">
        <p-progressBar [value]="progress" class="mt-3"></p-progressBar>

        <div class="flex flex-column gap-3 mt-4">
          <div *ngFor="let t of currentTasks" class="flex align-items-center gap-3">
            <p-checkbox [binary]="true" [(ngModel)]="t.checked" (ngModelChange)="saveState()"></p-checkbox>
            <label class="m-0">{{ t.label }}</label>
          </div>
        </div>
      </div>
    </p-card>

    <div class="mt-3">
      <div *ngIf="galleriaImages && galleriaImages.length > 0" class="card flex justify-center">
        <div class="thumbnail-grid">
          <div *ngFor="let image of galleriaImages; let index = index" class="thumbnail-item">
            <img [src]="image.thumbnailImageSrc" [alt]="image.alt || ('Imagem ' + (index+1))" class="thumbnail-img" (click)="activeIndex = index; displayCustom = true" />
          </div>
        </div>

        <p-galleria
          [value]="galleriaImages"
          [(visible)]="displayCustom"
          [(activeIndex)]="activeIndex"
          [responsiveOptions]="responsiveOptions"
          [numVisible]="7"
          [circular]="true"
          [fullScreen]="true"
          [showItemNavigators]="true"
          [showThumbnails]="false"
        >
          <ng-template pTemplate="item" let-item>
            <img [src]="item.itemImageSrc" style="width:100%; display:block; margin:0 auto; max-height:calc(100vh - 120px); object-fit:contain;" />
          </ng-template>
          <ng-template pTemplate="thumbnail" let-item>
            <img [src]="item.thumbnailImageSrc" class="w-3rem h-3rem object-cover" />
          </ng-template>
        </p-galleria>
      </div>
    </div>
  </div>


  <!-- Create Event Drawer -->
  <p-drawer [(visible)]="createSidebarVisible" position="right" [modal]="true" styleClass="w-full md:w-30rem" (onHide)="createSidebarVisible = false">
    <ng-template pTemplate="header">
      <div class="flex align-items-center gap-2">
        <i class="pi pi-plus text-primary"></i>
        <span class="font-semibold text-lg">Criar Evento</span>
      </div>
    </ng-template>

    <div class="p-4 flex flex-column gap-4">
      <div>
        <label class="font-medium text-900">Título</label>
        <input pInputText type="text" [(ngModel)]="newEventTitle" class="w-full" />
      </div>

      <div>
        <label class="font-medium text-900">Imagem (caminho)</label>
        <input pInputText type="text" [(ngModel)]="newEventImage" class="w-full" />
      </div>

      <div>
        <label class="font-medium text-900">Imagens para Galleria</label>
        <textarea [(ngModel)]="newEventImagesText" rows="4" class="w-full border-1 surface-border border-round p-2" placeholder="Cole URLs separadas por espaço ou vírgula"></textarea>
      </div>

      <div>
        <label class="font-medium text-900">Tarefas (uma por linha)</label>
        <textarea [(ngModel)]="newEventTasksText" rows="6" class="w-full border-1 surface-border border-round p-2"></textarea>
      </div>

      <div class="flex gap-2">
        <button pButton type="button" label="Criar" icon="pi pi-check" (click)="createEvent()" [disabled]="!newEventTitle.trim()"></button>
        <button pButton type="button" label="Cancelar" icon="pi pi-times" class="p-button-secondary" (click)="createSidebarVisible=false"></button>
      </div>
    </div>
  </p-drawer>

  <!-- Edit Event Drawer -->
  <p-drawer [(visible)]="editSidebarVisible" position="right" [modal]="true" styleClass="w-full md:w-30rem" (onHide)="editSidebarVisible = false">
    <ng-template pTemplate="header">
      <div class="flex align-items-center gap-2">
        <i class="pi pi-pencil text-primary"></i>
        <span class="font-semibold text-lg">Editar Evento</span>
      </div>
    </ng-template>

    <div class="p-4 flex flex-column gap-4">
      <div>
        <label class="font-medium text-900">Título</label>
        <input pInputText type="text" [(ngModel)]="editEventTitle" class="w-full" />
      </div>

      <div>
        <label class="font-medium text-900">Imagem (caminho)</label>
        <input pInputText type="text" [(ngModel)]="editEventImage" class="w-full" />
      </div>

      <div>
        <label class="font-medium text-900">Imagens para Galleria</label>
        <textarea [(ngModel)]="editEventImagesText" rows="4" class="w-full border-1 surface-border border-round p-2" placeholder="Cole URLs separadas por espaço ou vírgula"></textarea>
      </div>

      <div>
        <label class="font-medium text-900">Tarefas (uma por linha)</label>
        <textarea [(ngModel)]="editEventTasksText" rows="6" class="w-full border-1 surface-border border-round p-2"></textarea>
      </div>

      <div class="flex gap-2">
        <button pButton type="button" label="Salvar" icon="pi pi-check" (click)="saveEditEvent()" [disabled]="!editEventTitle.trim()"></button>
        <button pButton type="button" label="Excluir Evento" icon="pi pi-trash" class="p-button-danger" (click)="deleteEvent(editingEvent!)"></button>
      </div>
    </div>
  </p-drawer>

</div>
