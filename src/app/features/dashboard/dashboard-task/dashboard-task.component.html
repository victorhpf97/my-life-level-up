<p-card styleClass="w-full">
  <ng-template pTemplate="header">
    <div class="flex flex-column sm:flex-row align-items-start sm:align-items-center justify-content-between px-3 sm:px-4 py-3 sm:py-4 border-bottom-1 surface-border gap-3 sm:gap-0">
      <h2 class="text-xl font-semibold m-0 text-900">Task List</h2>
      <div class="flex align-items-center justify-content-center gap-3">
        <p-datePicker [(ngModel)]="selectedDate" [showIcon]="true" dateFormat="dd/mm/yy"></p-datePicker>
        <p-checkbox [(ngModel)]="allDates" [binary]="true" label="All dates" styleClass="ml-2"></p-checkbox>
      </div>
      <p-button 
        label="Create Task" 
        icon="pi pi-plus" 
        (onClick)="openCreateTaskSidebar()"
        size="small"
        styleClass="p-button-outlined w-full sm:w-auto">
      </p-button>
    </div>
  </ng-template>

  <ng-template pTemplate="content">
    <div class="px-3 sm:px-4 py-3 sm:py-4">
      
      <!-- Loading State -->
      <div *ngIf="isLoading" class="text-center py-4">
        <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
        <p class="mt-2 text-600">Carregando tasks do Firebase...</p>
      </div>

      <!-- Empty State -->
      <div *ngIf="!isLoading && tasks.length === 0" class="text-center py-4">
        <i class="pi pi-inbox" style="font-size: 3rem" class="text-400"></i>
        <h3 class="mt-3 text-600">Nenhuma task encontrada</h3>
        <p class="text-500">Clique em "Init Mock" para carregar dados de exemplo ou "Create Task" para criar uma nova task.</p>
      </div>

      <!-- Tasks Content -->
      <div *ngIf="!isLoading && tasks.length > 0">
        <!-- Dashboard Progress -->
        <div class="mb-6" *ngIf="filteredTasks().length > 0">
          <div class="flex flex-column gap-3 mb-3">
            <div class="flex align-items-center justify-content-between gap-3">
              <div class="flex align-items-center gap-3 flex-1">
                <div class="flex-1">
                  <p-progressBar [value]="dashboardProgress" [style]="{'height': '6px'}" [showValue]="false"></p-progressBar>
                  <div class="flex align-items-center justify-content-between mt-2">
                    <div class="text-sm text-600">{{ completedTaskCount }} / {{ totalTaskCount }} completadas — {{ dashboardProgress }}%</div>
                  </div>
                </div>
                <img src="assets/img/achievement.svg" alt="Achievement" style="height:40px; width:40px;" [style.filter]="isAllCompleted ? 'none' : 'grayscale(100%) brightness(0.6)'" [style.opacity]="isAllCompleted ? '1' : '0.6'">
              </div>
            </div>
          </div>
        </div>
        <!-- ToDo Section -->
      <div class="mb-6">
        <h3 class="text-lg font-medium mb-4 text-600">ToDo</h3>
        <div class="flex flex-column">
          <div 
            *ngFor="let task of todoTasks; let last = last" 
            class="flex flex-column sm:flex-row sm:align-items-center justify-content-between py-3 cursor-pointer gap-3 sm:gap-0"
            [class.border-bottom-1]="!last"
            [class.surface-border]="!last">
            
            <div class="flex align-items-start sm:align-items-center gap-3 flex-1">
              <!-- Checkbox para tasks normais -->
              <p-checkbox 
                *ngIf="task.type === 'checkbox'"
                [binary]="true"
                [ngModel]="task.completed"
                (ngModelChange)="toggleTaskCompletion(task)"
                styleClass="mt-1 sm:mt-0">
              </p-checkbox>
              
              <!-- Timer controls para tasks de tempo -->
              <div *ngIf="task.type === 'timer'" class="flex align-items-center gap-2 mt-1 sm:mt-0">
                <!-- Play/Pause button -->
                <p-button 
                  *ngIf="!task.isRunning && !task.completed"
                  icon="pi pi-play"
                  [text]="true"
                  size="small"
                  severity="success"
                  (onClick)="startTimer(task); $event.stopPropagation()"
                  pTooltip="Iniciar Timer"
                  styleClass="p-0">
                </p-button>
                
                <p-button 
                  *ngIf="task.isRunning && !task.completed"
                  icon="pi pi-pause"
                  [text]="true"
                  size="small"
                  severity="warn"
                  (onClick)="pauseTimer(task); $event.stopPropagation()"
                  pTooltip="Pausar Timer"
                  styleClass="p-0">
                </p-button>
                
                <!-- Status indicator -->
                <div 
                  *ngIf="task.completed"
                  class="w-1rem h-1rem border-circle bg-green-500 flex align-items-center justify-content-center">
                  <i class="pi pi-check text-xs text-white"></i>
                </div>
              </div>
              
              <div class="flex flex-column flex-1">
                <div class="flex align-items-center gap-2 mb-1">
                  <!-- priority tag replaced by coin image -->
                  <img 
                    [src]="getTaskImageUrl(task)"
                    alt="coin" 
                    class="mr-2 hidden sm:block"
                    style="width:28px;height:28px;object-fit:cover;border-radius:6px">
                  <span class="text-900 font-medium">{{ task.title }}</span>
                </div>
                <span class="text-600 text-sm">{{ task.description }}</span>
                
                <!-- Timer info -->
                <div *ngIf="task.type === 'timer'" class="flex align-items-center gap-2 mt-2">
                  <span class="text-primary font-mono text-sm">
                    {{ formatTime(getDisplayTime(task)) }}
                  </span>
                  <!-- Debug button temporário -->
                  <p-button 
                    icon="pi pi-info-circle"
                    [text]="true"
                    size="small"
                    severity="info"
                    (onClick)="debugTimer(task); $event.stopPropagation()"
                    pTooltip="Debug Timer"
                    styleClass="p-0 text-xs">
                  </p-button>
                  <div class="flex-1">
                    <p-progressBar 
                      [value]="getTimerProgress(task)"
                      [style]="{'height': '4px'}"
                      [showValue]="false">
                    </p-progressBar>
                    <!-- Debug progress value temporário -->
                    <span class="text-xs text-400">{{ getTimerProgress(task).toFixed(1) }}%</span>
                  </div>
                  <span class="text-xs text-500">
                    {{ task.duration }}min
                  </span>
                </div>
              </div>
            </div>

            <div class="flex flex-row sm:flex-row align-items-center justify-content-between gap-2 sm:gap-3 w-full sm:w-auto">
              <!-- Reset button para timer -->
              <p-button 
                *ngIf="task.type === 'timer' && !task.completed"
                icon="pi pi-refresh"
                [text]="true"
                size="small"
                severity="secondary"
                (onClick)="resetTimer(task); $event.stopPropagation()"
                pTooltip="Resetar Timer"
                styleClass="p-button-rounded">
              </p-button>
              
       

              <!-- Menu Button - fixo no canto direito -->
              <p-button 
                icon="pi pi-ellipsis-v" 
                [text]="true"
                size="small"
                (onClick)="openEditSidebar(task)"
                styleClass="p-button-rounded p-button-text flex-shrink-0">
              </p-button>
            </div>
          </div>
        </div>
      </div>

      <!-- Completed Section -->
      <div>
        <h3 class="text-lg font-medium mb-4 text-600">Completed</h3>
        <div class="flex flex-column">
          <div 
            *ngFor="let task of completedTasks; let last = last" 
            class="flex flex-column sm:flex-row sm:align-items-center justify-content-between py-3 cursor-pointer gap-3 sm:gap-0"
            [class.border-bottom-1]="!last"
            [class.surface-border]="!last"
            style="opacity: 0.7;">
            
            <div class="flex align-items-start sm:align-items-center gap-3 flex-1">
              <p-checkbox 
                [binary]="true"
                [ngModel]="task.completed"
                (ngModelChange)="toggleTaskCompletion(task)"
                styleClass="mt-1 sm:mt-0">
              </p-checkbox>
              
              <div class="flex flex-column flex-1">
                <span class="text-900 font-medium mb-1 line-through">{{ task.title }}</span>
                <span class="text-600 text-sm line-through">{{ task.description }}</span>
              </div>
            </div>

            <div class="flex flex-row sm:flex-row align-items-center justify-content-between gap-2 sm:gap-3 w-full sm:w-auto">
              <!-- priority tag replaced by coin image -->
              <img 
                [src]="getTaskImageUrl(task)" 
                alt="coin" 
                style="width:28px;height:28px;object-fit:cover;border-radius:6px"
                class="flex-shrink-0">

              <!-- Menu Button - fixo no canto direito -->
              <p-button 
                icon="pi pi-ellipsis-v" 
                [text]="true"
                size="small"
                (onClick)="openEditSidebar(task)"
                styleClass="p-button-rounded p-button-text flex-shrink-0">
              </p-button>
            </div>
          </div>
        </div>
      </div>
      </div> <!-- Fecha div do Tasks Content -->
    </div>
  </ng-template>
</p-card>

<!-- Task Edit Sidebar -->
<app-task-edit-sidebar
  [visible]="sidebarVisible"
  [task]="selectedTask"
  (visibleChange)="onSidebarVisibleChange($event)"
  (taskSaved)="onTaskSaved($event)"
  (taskDeleted)="onTaskDeleted($event)">
</app-task-edit-sidebar>